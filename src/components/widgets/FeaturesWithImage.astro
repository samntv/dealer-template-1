---
import { Icon } from "astro-icon/components";

interface Card {
  title?: string;
  description?: string;
  icon?: string;
  image?: string;
}

interface Props {
  title?: string;
  eyebrow?: string;
  description?: string;
  cards: Card[];
  ctaText?: string;
  ctaLink?: string;
  isCarousel?: boolean; // Enable carousel mode
  itemsPerSlide?: number; // Number of items visible per slide (default: 2)
  carouselAutoplay?: boolean; // Auto-advance slides
  carouselAutoplayDelay?: number; // Delay in ms (default: 5000)
}

const {
  title,
  eyebrow,
  description,
  cards = [],
  ctaText,
  ctaLink,
  isCarousel: isCarouselProp,
  itemsPerSlide = 2,
  carouselAutoplay = false,
  carouselAutoplayDelay = 5000,
} = Astro.props;

// Automatically enable carousel if more than 4 cards, otherwise use prop value
const isCarousel = cards.length > 4 ? true : (isCarouselProp || false);

// Show all cards if carousel, otherwise limit to max 4
const displayCards = isCarousel ? cards : cards.slice(0, 4);
const cardCount = displayCards.length;

// Adaptive grid classes based on card count
const getGridClasses = () => {
  switch (cardCount) {
    case 1:
      return "grid grid-cols-1 max-w-md mx-auto";
    case 2:
      return "grid grid-cols-1 sm:grid-cols-2 max-w-3xl mx-auto";
    case 3:
      return "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 max-w-5xl mx-auto";
    case 4:
    default:
      return "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4";
  }
};

const carouselId = `carousel-${Math.random().toString(36).substring(2, 9)}`;
---

<section class="py-12 sm:py-16 md:py-24 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {
      (eyebrow || title || description) && (
        <div class="text-center mb-8 sm:mb-12">
          {eyebrow && (
            <p class="text-xs sm:text-sm font-bold text-primary uppercase tracking-wider mb-2">
              {eyebrow}
            </p>
          )}
          {title && (
            <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-primary-dark mb-4">
              {title}
            </h2>
          )}
          {description && (
            <p class="text-base sm:text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
              {description}
            </p>
          )}
        </div>
      )
    }

    {
      isCarousel ? (
        <div class="relative">
          {/* Carousel Container */}
          <div class="overflow-hidden" id={carouselId}>
            <div
              class="flex transition-transform duration-500 ease-in-out"
              data-carousel-track
            >
              {displayCards.map((card) => (
                <div
                  class="flex-shrink-0 px-3"
                  style={`width: ${100 / itemsPerSlide}%`}
                >
                  <div class="bg-white rounded-lg overflow-hidden transition h-full">
                    {card.image && (
                      <div class="relative h-48 overflow-hidden">
                        <img
                          src={card.image}
                          alt={card.title || "Card image"}
                          class="w-full h-full object-cover"
                          loading="lazy"
                        />
                      </div>
                    )}
                    <div class="p-6">
                      {card.icon && (
                        <div class="w-12 h-12 bg-primary-dark rounded-full flex items-center justify-center mb-4 mx-auto">
                          <Icon name={card.icon} class="w-6 h-6 text-white" />
                        </div>
                      )}
                      {card.title && (
                        <h3
                          class="text-lg font-bold text-primary-dark mb-2 text-center"
                          set:html={card.title}
                        />
                      )}
                      {card.description && (
                        <p class="text-sm text-gray-600 text-center">
                          {card.description}
                        </p>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Navigation Buttons */}
          <button
            class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition z-10"
            data-carousel-prev
            aria-label="Previous slide"
          >
            <svg
              class="w-6 h-6 text-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <button
            class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-white rounded-full p-3 shadow-lg hover:bg-gray-100 transition z-10"
            data-carousel-next
            aria-label="Next slide"
          >
            <svg
              class="w-6 h-6 text-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>

          {/* Dots Indicator */}
          <div class="flex justify-center gap-2 mt-6">
            {Array.from({
              length: Math.ceil(displayCards.length / itemsPerSlide),
            }).map((_, index) => (
              <button
                class="w-3 h-3 rounded-full bg-gray-300 hover:bg-primary transition"
                data-carousel-dot={index}
                aria-label={`Go to slide ${index + 1}`}
              />
            ))}
          </div>
        </div>
      ) : (
        <div class={`${getGridClasses()} gap-6 lg:gap-8`}>
          {displayCards.map((card) => (
            <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-xl transition">
              {card.image && (
                <div class="relative h-48 overflow-hidden">
                  <img
                    src={card.image}
                    alt={card.title || "Card image"}
                    class="w-full h-full object-cover"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-6">
                {card.icon && (
                  <div class="w-12 h-12 bg-primary-dark rounded-full flex items-center justify-center mb-4 mx-auto">
                    <Icon name={card.icon} class="w-6 h-6 text-white" />
                  </div>
                )}
                {card.title && (
                  <h3
                    class="text-lg font-bold text-primary-dark mb-2 text-center"
                    set:html={card.title}
                  />
                )}
                {card.description && (
                  <p class="text-sm text-gray-600 text-center">
                    {card.description}
                  </p>
                )}
              </div>
            </div>
          ))}
        </div>
      )
    }

    {
      ctaText && ctaLink && (
        <div class="text-center mt-8 sm:mt-12">
          <a
            href={ctaLink}
            class="inline-block px-6 py-3 sm:px-8 sm:py-4 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition text-sm sm:text-base"
          >
            {ctaText}
          </a>
        </div>
      )
    }
  </div>
</section>

{
  isCarousel && (
    <script
      is:inline
      define:vars={{
        carouselId,
        itemsPerSlide,
        autoplay: carouselAutoplay,
        autoplayDelay: carouselAutoplayDelay,
        totalCards: displayCards.length,
      }}
    >
      function initCarousel() {
        const carousel = document.getElementById(carouselId);
        if (!carousel) return;

        const track = carousel.querySelector("[data-carousel-track]");
        const prevBtn = carousel
          .closest("section")
          .querySelector("[data-carousel-prev]");
        const nextBtn = carousel
          .closest("section")
          .querySelector("[data-carousel-next]");
        const dots = carousel
          .closest("section")
          .querySelectorAll("[data-carousel-dot]");

        let currentIndex = 0;
        const totalSlides = Math.ceil(totalCards / itemsPerSlide);
        let autoplayInterval;

        function updateCarousel() {
          const offset = -(currentIndex * 100);
          track.style.transform = `translateX(${offset}%)`;

          // Update dots
          dots.forEach((dot, index) => {
            if (index === currentIndex) {
              dot.classList.add("bg-primary");
              dot.classList.remove("bg-gray-300");
            } else {
              dot.classList.remove("bg-primary");
              dot.classList.add("bg-gray-300");
            }
          });

          // Buttons always enabled for infinite loop
          prevBtn.disabled = false;
          nextBtn.disabled = false;
          prevBtn.style.opacity = "1";
          nextBtn.style.opacity = "1";
        }

        function goToSlide(index) {
          currentIndex = Math.max(0, Math.min(index, totalSlides - 1));
          updateCarousel();
          resetAutoplay();
        }

        function nextSlide() {
          if (currentIndex < totalSlides - 1) {
            goToSlide(currentIndex + 1);
          } else {
            goToSlide(0); // Loop back to start
          }
        }

        function prevSlide() {
          if (currentIndex > 0) {
            goToSlide(currentIndex - 1);
          } else {
            goToSlide(totalSlides - 1); // Loop to end
          }
        }

        function resetAutoplay() {
          if (autoplay) {
            clearInterval(autoplayInterval);
            autoplayInterval = setInterval(nextSlide, autoplayDelay);
          }
        }

        // Event listeners
        prevBtn?.addEventListener("click", prevSlide);
        nextBtn?.addEventListener("click", nextSlide);

        dots.forEach((dot, index) => {
          dot.addEventListener("click", () => goToSlide(index));
        });

        // Keyboard navigation
        carousel.addEventListener("keydown", (e) => {
          if (e.key === "ArrowLeft") prevSlide();
          if (e.key === "ArrowRight") nextSlide();
        });

        // Touch/swipe support
        let touchStartX = 0;
        let touchEndX = 0;

        carousel.addEventListener("touchstart", (e) => {
          touchStartX = e.changedTouches[0].screenX;
        });

        carousel.addEventListener("touchend", (e) => {
          touchEndX = e.changedTouches[0].screenX;
          if (touchStartX - touchEndX > 50) nextSlide();
          if (touchEndX - touchStartX > 50) prevSlide();
        });

        // Initialize
        updateCarousel();
        if (autoplay) {
          autoplayInterval = setInterval(nextSlide, autoplayDelay);
        }

        // Pause autoplay on hover
        if (autoplay) {
          carousel.addEventListener("mouseenter", () =>
            clearInterval(autoplayInterval)
          );
          carousel.addEventListener("mouseleave", resetAutoplay);
        }
      }

      // Initialize on load and after page transitions
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initCarousel);
      } else {
        initCarousel();
      }
      document.addEventListener("astro:after-swap", initCarousel);
    </script>
  )
}
