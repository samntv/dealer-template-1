---
interface FormField {
  id: string;
  name: string;
  label: string;
  type:
    | "text"
    | "email"
    | "tel"
    | "number"
    | "textarea"
    | "select"
    | "checkbox"
    | "radio";
  placeholder?: string;
  required?: boolean;
  options?: string[]; // For select, radio
  rows?: number; // For textarea
  pattern?: string;
  helpText?: string;
  width?: "full" | "half"; // Layout width
}

interface Props {
  title?: string;
  subtitle?: string;
  description?: string;
  fields: FormField[];
  submitText?: string;
  submitAction?: string;
  method?: "POST" | "GET";
  successMessage?: string;
  background?: string;
  showRecaptcha?: boolean;
  recaptchaSiteKey?: string;
}

const {
  title = "Get In Touch",
  subtitle = "We'd love to hear from you",
  description = "Fill out the form below and we'll get back to you as soon as possible.",
  fields = [],
  submitText = "Submit",
  submitAction = "/api/contact",
  method = "POST",
  successMessage = "Thank you! We'll be in touch soon.",
  background = "white",
  showRecaptcha = true,
  recaptchaSiteKey = "6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI", // Test key - replace with your actual key
} = Astro.props;

const bgClass =
  background === "primary-dark" ? "bg-primary-dark text-white" : "bg-white";
---

<section class={`py-12 sm:py-16 md:py-24 ${bgClass}`}>
  <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    {
      (title || subtitle || description) && (
        <div class="text-center mb-10 sm:mb-12">
          {subtitle && (
            <p class="text-xs sm:text-sm font-semibold text-primary uppercase tracking-wider mb-3">
              {subtitle}
            </p>
          )}
          {title && (
            <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-4 sm:mb-6 text-gray-900">{title}</h2>
          )}
          {description && (
            <p class="text-sm sm:text-base text-gray-600 max-w-xl mx-auto leading-relaxed">{description}</p>
          )}
        </div>
      )
    }

    <!-- Form Container -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 sm:p-8 md:p-10">
      <form
        action={submitAction}
        method={method}
        class="space-y-6"
        id="contact-form"
      >
      <div class="space-y-5">
        {
          fields.map((field) => {
            return (
              <div>
                {/* Label */}
                {field.label && field.type !== "checkbox" && (
                  <label
                    for={field.id}
                    class="block text-sm font-semibold text-gray-700 mb-2"
                  >
                    {field.label}
                    {field.required && <span class="text-red-500 ml-1">*</span>}
                  </label>
                )}

                {/* Text Input */}
                {(field.type === "text" ||
                  field.type === "email" ||
                  field.type === "tel" ||
                  field.type === "number") && (
                  <input
                    type={field.type}
                    id={field.id}
                    name={field.name}
                    placeholder={field.placeholder}
                    required={field.required}
                    pattern={field.pattern}
                    class="w-full px-4 py-3.5 text-base border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none bg-gray-50 hover:bg-white hover:border-gray-300"
                  />
                )}

                {/* Textarea */}
                {field.type === "textarea" && (
                  <textarea
                    id={field.id}
                    name={field.name}
                    placeholder={field.placeholder}
                    required={field.required}
                    rows={field.rows || 4}
                    class="w-full px-4 py-3.5 text-base border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none resize-none bg-gray-50 hover:bg-white hover:border-gray-300"
                  />
                )}

                {/* Select */}
                {field.type === "select" && field.options && (
                  <select
                    id={field.id}
                    name={field.name}
                    required={field.required}
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition"
                  >
                    <option value="">Select an option</option>
                    {field.options.map((option) => (
                      <option value={option}>{option}</option>
                    ))}
                  </select>
                )}

                {/* Checkbox */}
                {field.type === "checkbox" && (
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      id={field.id}
                      name={field.name}
                      required={field.required}
                      class="mt-1 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                    />
                    <label for={field.id} class="ml-2 text-sm text-gray-700">
                      {field.label}
                      {field.required && (
                        <span class="text-red-500 ml-1">*</span>
                      )}
                    </label>
                  </div>
                )}

                {/* Radio */}
                {field.type === "radio" && field.options && (
                  <div class="space-y-2">
                    {field.options.map((option, idx) => (
                      <div class="flex items-center">
                        <input
                          type="radio"
                          id={`${field.id}-${idx}`}
                          name={field.name}
                          value={option}
                          required={field.required}
                          class="h-4 w-4 text-primary border-gray-300 focus:ring-primary"
                        />
                        <label
                          for={`${field.id}-${idx}`}
                          class="ml-2 text-sm text-gray-700"
                        >
                          {option}
                        </label>
                      </div>
                    ))}
                  </div>
                )}

                {/* Help Text */}
                {field.helpText && (
                  <p class="mt-1 text-sm text-gray-500">{field.helpText}</p>
                )}
              </div>
            );
          })
        }
      </div>

      <!-- reCAPTCHA -->
      {
        showRecaptcha && (
          <div class="space-y-2 pt-2">
            <label class="block text-sm font-semibold text-gray-700 mb-3">
              Verification<span class="text-red-500 ml-1">*</span>
            </label>
            <div class="flex justify-center sm:justify-start">
              <div
                id="recaptcha-container"
                class="g-recaptcha inline-block"
                data-sitekey={recaptchaSiteKey}
                data-theme="light"
              />
            </div>
            <p id="recaptcha-error" class="text-red-500 text-sm font-medium hidden mt-2">
              Please complete the reCAPTCHA verification.
            </p>
          </div>
        )
      }

      <!-- Submit Button -->
      <div class="pt-6">
        <button
          type="submit"
          id="submit-button"
          class="w-full px-8 py-4 bg-primary-dark text-white text-sm font-bold uppercase tracking-wider rounded-lg hover:bg-primary hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        >
          {submitText}
        </button>
      </div>

      <!-- Success Message (hidden by default) -->
      <div
        id="success-message"
        class="hidden p-5 bg-green-50 border-2 border-green-200 rounded-lg text-green-800 text-center font-medium"
      >
        {successMessage}
      </div>
    </form>
    </div>
  </div>
</section>

<!-- reCAPTCHA Script -->
<script
  src="https://www.google.com/recaptcha/api.js"
  async
  defer
  is:inline
></script>

<script>
  function initForm() {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const successMessage = document.getElementById("success-message");
    const submitButton = document.getElementById("submit-button") as HTMLButtonElement;
    const recaptchaError = document.getElementById("recaptcha-error");
    const recaptchaContainer = document.getElementById("recaptcha-container");

    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check reCAPTCHA if enabled
        if (recaptchaContainer) {
          const recaptchaResponse = (window as any).grecaptcha?.getResponse();
          
          if (!recaptchaResponse) {
            recaptchaError?.classList.remove("hidden");
            recaptchaContainer.classList.add("ring-2", "ring-red-500", "rounded");
            return;
          } else {
            recaptchaError?.classList.add("hidden");
            recaptchaContainer.classList.remove("ring-2", "ring-red-500", "rounded");
          }
        }

        // Disable submit button
        submitButton.disabled = true;
        const originalText = submitButton.textContent;
        submitButton.textContent = "SUBMITTING...";

        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        try {
          // You can replace this with your actual form submission logic
          console.log("Form data:", data);

          // Simulate API call
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // Show success message
          form.classList.add("hidden");
          successMessage?.classList.remove("hidden");

          // Reset form and reCAPTCHA after 3 seconds
          setTimeout(() => {
            form.reset();
            if ((window as any).grecaptcha) {
              (window as any).grecaptcha.reset();
            }
            form.classList.remove("hidden");
            successMessage?.classList.add("hidden");
            submitButton.disabled = false;
            submitButton.textContent = originalText;
          }, 3000);
        } catch (error) {
          console.error("Form submission error:", error);
          alert("There was an error submitting the form. Please try again.");
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });

      // Remove error when user interacts with reCAPTCHA
      if (recaptchaContainer) {
        const checkRecaptcha = setInterval(() => {
          const recaptchaResponse = (window as any).grecaptcha?.getResponse();
          if (recaptchaResponse) {
            recaptchaError?.classList.add("hidden");
            recaptchaContainer.classList.remove("ring-2", "ring-red-500", "rounded");
          }
        }, 500);

        // Cleanup interval when form is removed
        const observer = new MutationObserver((mutations) => {
          if (!document.body.contains(form)) {
            clearInterval(checkRecaptcha);
            observer.disconnect();
          }
        });
        observer.observe(document.body, { childList: true, subtree: true });
      }
    }
  }

  // Wait for reCAPTCHA to load
  if ((window as any).grecaptcha) {
    initForm();
  } else {
    window.addEventListener("load", () => {
      setTimeout(initForm, 500);
    });
  }
  
  document.addEventListener("astro:after-swap", () => {
    setTimeout(initForm, 500);
  });
</script>
