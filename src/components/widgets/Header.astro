---
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import { headerData } from "~/navigation";
import { getPermalink } from "~/utils/permalinks";
import { SITE_NAME } from "~/utils/config";
import ToggleMenu from "../ui/ToggleMenu.astro";

// Hydrate navigation with content collections
const solutions = await getCollection("solutions");
const billboards = await getCollection("indoor-billboards");

const foundational = solutions
  .filter((s) => s.data.category === "foundational")
  .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

const leadGen = solutions
  .filter((s) => s.data.category === "lead-gen")
  .sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

const sortedBillboards = billboards.sort(
  (a, b) => (a.data.order || 0) - (b.data.order || 0)
);

// Hydrate the config
const links = headerData.links.map((link: any) => {
  if (link.text === "Indoor Billboards" && link.links === "auto") {
    return {
      ...link,
      links: sortedBillboards.map((item) => ({
        text: item.data.title,
        description: item.data.description,
        icon: item.data.icon,
        thumbnail: item.data.thumbnail,
        href: getPermalink(`/indoor-billboards/${item.slug}`),
      })),
    };
  }

  if (link.text === "Solutions" && Array.isArray(link.links)) {
    return {
      ...link,
      links: link.links.map((sublink: any) => {
        if (sublink.text === "Foundational" && sublink.links === "auto") {
          return {
            ...sublink,
            links: foundational.map((item) => ({
              text: item.data.title,
              description: item.data.description,
              icon: item.data.icon,
              thumbnail: item.data.thumbnail,
              href: getPermalink(
                `/solutions/foundational/${item.slug.replace("foundational/", "")}`
              ),
            })),
          };
        }
        if (sublink.text === "Lead Gen" && sublink.links === "auto") {
          return {
            ...sublink,
            links: leadGen.map((item) => ({
              text: item.data.title,
              description: item.data.description,
              icon: item.data.icon,
              thumbnail: item.data.thumbnail,
              href: getPermalink(
                `/solutions/lead-gen/${item.slug.replace("lead-gen/", "")}`
              ),
            })),
          };
        }
        return sublink;
      }),
    };
  }

  return link;
});

const { actions = [] } = headerData;
---

<header
  class="sticky top-0 z-40 flex-none mx-auto w-full bg-white border-b border-gray-200"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <div class="flex-shrink-0">
        <a href="/" class="flex items-center">
          <img 
            src="https://ntxidb.com/wp-content/uploads/2024/08/NTX-Digital-Logo.png" 
            alt={SITE_NAME}
            class="h-10 w-auto"
          />
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex md:items-center md:space-x-4">
        <nav
          class="flex items-center space-x-1 relative"
          aria-label="Main navigation"
        >
          {
            links.map((link, index) => (
              <div class="relative" data-dropdown={`dropdown-${index}`}>
                {link.links && link.links.length > 0 ? (
                  <>
                    <button class="dropdown-toggle px-4 py-2 text-sm font-medium text-gray-700 hover:text-primary inline-flex items-center">
                      {link.text}
                      <svg
                        class="ml-1 h-4 w-4 transition-transform"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M19 9l-7 7-7-7"
                        />
                      </svg>
                    </button>
                    {/* Mega Menu for Solutions */}
                    {link.text === "Solutions" ? (
                      <div class="dropdown-menu absolute left-1/2 -translate-x-1/2 mt-2 xl:w-[1024px] lg:w-[600px] w-[400px] max-w-[calc(100vw-2rem)] opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                        <div class="rounded-xl shadow-2xl bg-white ring-1 ring-gray-200 overflow-hidden">
                          <div class="grid xl:grid-cols-3 grid-cols-1 xl:divide-x divide-gray-100">
                            {/* Categories Column */}
                            <div class="xl:col-span-2 p-6">
                              <div class="grid xl:grid-cols-2 grid-cols-1 gap-x-6 gap-y-4">
                                {link.links.map((sublink) => (
                                  <div>
                                    <a
                                      href={sublink.href}
                                      class="inline-flex items-center gap-2 text-xs font-bold text-primary uppercase tracking-wider mb-4 hover:text-primary-dark"
                                    >
                                      {sublink.text}
                                      <svg
                                        class="w-3 h-3"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                      >
                                        <path
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          stroke-width="2"
                                          d="M9 5l7 7-7 7"
                                        />
                                      </svg>
                                    </a>
                                    {sublink.links &&
                                      sublink.links.length > 0 && (
                                        <div class="space-y-1">
                                          {sublink.links.map((nestedLink) => (
                                            <a
                                              href={nestedLink.href}
                                              class="group/item flex items-start gap-3 p-3 rounded-lg hover:bg-neutral transition-all"
                                            >
                                              {nestedLink.icon && (
                                                <div class="flex-shrink-0 w-10 h-10 bg-neutral rounded-lg flex items-center justify-center group-hover/item:bg-primary transition-colors">
                                                  <Icon
                                                    name={nestedLink.icon}
                                                    class="w-5 h-5 text-primary group-hover/item:text-white transition-colors"
                                                  />
                                                </div>
                                              )}
                                              <div class="flex-1 min-w-0">
                                                <div class="text-sm font-semibold text-gray-900 group-hover/item:text-primary transition-colors">
                                                  {nestedLink.text}
                                                </div>
                                                {nestedLink.description && (
                                                  <div class="text-xs text-gray-500 mt-0.5 line-clamp-2">
                                                    {nestedLink.description}
                                                  </div>
                                                )}
                                              </div>
                                            </a>
                                          ))}
                                        </div>
                                      )}
                                  </div>
                                ))}
                              </div>
                            </div>

                            {/* Featured Section */}
                            <div class="hidden xl:block bg-gradient-to-br from-neutral to-white p-8">
                              <div class="text-xs font-bold text-primary uppercase tracking-wider mb-4">
                                Featured
                              </div>
                              <a
                                href="/solutions/foundational/website-design"
                                class="group block"
                              >
                                <div class="relative h-32 rounded-lg overflow-hidden mb-4 shadow-md">
                                  <img
                                    src="https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=400&h=300&fit=crop"
                                    alt="Website Design"
                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                  />
                                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
                                  <div class="absolute bottom-3 left-3 right-3">
                                    <div class="text-white font-bold text-sm">
                                      Website Design
                                    </div>
                                  </div>
                                </div>
                                <p class="text-xs text-gray-600 mb-4">
                                  Custom websites that drive results and grow
                                  your business online.
                                </p>
                                <span class="inline-flex items-center gap-1 text-xs font-semibold text-primary group-hover:gap-2 transition-all">
                                  Learn More
                                  <svg
                                    class="w-3 h-3"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M9 5l7 7-7 7"
                                    />
                                  </svg>
                                </span>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Modern dropdown for other menus - auto-adjust position */
                      <div class="dropdown-menu absolute left-0 lg:left-auto lg:right-0 mt-2 w-80 max-w-[calc(100vw-2rem)] opacity-0 invisible pointer-events-none transition-all duration-200 z-50">
                        <div class="rounded-xl shadow-2xl bg-white ring-1 ring-gray-200 overflow-hidden">
                          <div class="p-6">
                            <a
                              href={link.href}
                              class="inline-flex items-center gap-2 text-xs font-bold text-primary uppercase tracking-wider mb-4 hover:text-primary-dark"
                            >
                              Overview
                              <svg
                                class="w-3 h-3"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M9 5l7 7-7 7"
                                />
                              </svg>
                            </a>
                            <div class="space-y-1">
                              {link.links.map((sublink) => (
                                <a
                                  href={sublink.href}
                                  class="group/item flex items-start gap-3 p-3 rounded-lg hover:bg-neutral transition-all"
                                >
                                  {sublink.icon && (
                                    <div class="flex-shrink-0 w-10 h-10 bg-neutral rounded-lg flex items-center justify-center group-hover/item:bg-primary transition-colors">
                                      <Icon
                                        name={sublink.icon}
                                        class="w-5 h-5 text-primary group-hover/item:text-white transition-colors"
                                      />
                                    </div>
                                  )}
                                  <div class="flex-1 min-w-0">
                                    <div class="text-sm font-semibold text-gray-900 group-hover/item:text-primary transition-colors">
                                      {sublink.text}
                                    </div>
                                    {sublink.description && (
                                      <div class="text-xs text-gray-500 mt-0.5 line-clamp-2">
                                        {sublink.description}
                                      </div>
                                    )}
                                  </div>
                                </a>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                ) : (
                  <a
                    href={link.href}
                    class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-primary"
                  >
                    {link.text}
                  </a>
                )}
              </div>
            ))
          }
        </nav>

        <!-- CTA Actions -->
        {
          actions.length > 0 && (
            <div class="flex items-center gap-3">
              {actions.map((action) => (
                <a
                  href={action.href}
                  class="px-5 py-2 text-sm font-medium rounded-lg bg-primary text-white hover:bg-primary-dark transition"
                >
                  {action.text}
                </a>
              ))}
            </div>
          )
        }
      </div>

      <!-- Mobile menu button -->
      <div class="flex md:hidden">
        <ToggleMenu />
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200">
    <div class="px-2 pt-2 pb-3 space-y-1">
      {
        links.map((link) => (
          <div>
            {link.links && link.links.length > 0 ? (
              <>
                <button class="mobile-dropdown-btn w-full flex items-center justify-between px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary rounded-md">
                  {link.text}
                  <svg
                    class="h-5 w-5 transform transition-transform"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>
                <div class="mobile-dropdown-content hidden pl-4 space-y-1">
                  <a
                    href={link.href}
                    class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 hover:text-primary rounded-md"
                  >
                    Overview
                  </a>
                  {link.links.map((sublink) => (
                    <div>
                      {sublink.links && sublink.links.length > 0 ? (
                        <>
                          <button class="mobile-dropdown-btn w-full flex items-center justify-between px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 hover:text-primary rounded-md">
                            {sublink.text}
                            <svg
                              class="h-4 w-4 transform transition-transform"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 9l-7 7-7-7"
                              />
                            </svg>
                          </button>
                          <div class="mobile-dropdown-content hidden pl-4 space-y-1">
                            {sublink.links.map((nestedLink) => (
                              <a
                                href={nestedLink.href}
                                class="flex items-center gap-2 px-3 py-2 text-xs text-gray-500 hover:bg-gray-50 hover:text-primary rounded-md"
                              >
                                {nestedLink.icon && (
                                  <Icon
                                    name={nestedLink.icon}
                                    class="w-3.5 h-3.5 flex-shrink-0"
                                  />
                                )}
                                <span>{nestedLink.text}</span>
                              </a>
                            ))}
                          </div>
                        </>
                      ) : (
                        <a
                          href={sublink.href}
                          class="block px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 hover:text-primary rounded-md"
                        >
                          {sublink.text}
                        </a>
                      )}
                    </div>
                  ))}
                </div>
              </>
            ) : (
              <a
                href={link.href}
                class="block px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary rounded-md"
              >
                {link.text}
              </a>
            )}
          </div>
        ))
      }
    </div>
  </div>
</header>

<script>
  function initMobileMenu() {
    const toggleButton = document.querySelector(".ml-1\\.5");
    const mobileMenu = document.getElementById("mobile-menu");

    toggleButton?.addEventListener("click", () => {
      mobileMenu?.classList.toggle("hidden");
    });

    document.querySelectorAll(".mobile-dropdown-btn").forEach((button) => {
      button.addEventListener("click", (e) => {
        e.preventDefault();
        const content = button.nextElementSibling;
        const svg = button.querySelector("svg");

        content?.classList.toggle("hidden");
        svg?.classList.toggle("rotate-180");
      });
    });
  }

  function initSmartDropdowns() {
    // Click-based dropdown navigation
    const dropdownToggles = document.querySelectorAll(".dropdown-toggle");

    dropdownToggles.forEach((toggle) => {
      toggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const parent = toggle.closest("[data-dropdown]");
        const dropdown = parent?.querySelector(".dropdown-menu");
        const arrow = toggle.querySelector("svg");

        if (!dropdown) return;

        // Close all other dropdowns
        document.querySelectorAll(".dropdown-menu").forEach((menu) => {
          if (menu !== dropdown) {
            menu.classList.remove(
              "opacity-100",
              "visible",
              "pointer-events-auto"
            );
            menu.classList.add("opacity-0", "invisible", "pointer-events-none");
          }
        });

        // Reset all arrows
        document.querySelectorAll(".dropdown-toggle svg").forEach((svg) => {
          if (svg !== arrow) {
            svg.classList.remove("rotate-180");
          }
        });

        // Toggle current dropdown
        const isOpen = dropdown.classList.contains("opacity-100");
        if (isOpen) {
          dropdown.classList.remove(
            "opacity-100",
            "visible",
            "pointer-events-auto"
          );
          dropdown.classList.add(
            "opacity-0",
            "invisible",
            "pointer-events-none"
          );
          arrow?.classList.remove("rotate-180");
        } else {
          dropdown.classList.remove(
            "opacity-0",
            "invisible",
            "pointer-events-none"
          );
          dropdown.classList.add(
            "opacity-100",
            "visible",
            "pointer-events-auto"
          );
          arrow?.classList.add("rotate-180");
        }
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (!target.closest("[data-dropdown]")) {
        document.querySelectorAll(".dropdown-menu").forEach((menu) => {
          menu.classList.remove(
            "opacity-100",
            "visible",
            "pointer-events-auto"
          );
          menu.classList.add("opacity-0", "invisible", "pointer-events-none");
        });
        document.querySelectorAll(".dropdown-toggle svg").forEach((svg) => {
          svg.classList.remove("rotate-180");
        });
      }
    });
  }

  initMobileMenu();
  initSmartDropdowns();
  document.addEventListener("astro:after-swap", () => {
    initMobileMenu();
    initSmartDropdowns();
  });
</script>
